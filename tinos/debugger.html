<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Root Debugger | System Root</title>
    <style>
        :root { --primary: #007aff; --bg: #000; --card-bg: #1c1c1e; --text: #fff; --code: #32d74b; --danger: #ff3b30; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; overflow: hidden; height: 100vh; box-sizing: border-box; }
        
        /* 1. Loading & Auth (完全保留原本邏輯) */
        #check-screen, #auth-overlay { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 30px; height: 30px; border: 3px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .auth-card { background: var(--card-bg); padding: 30px; border-radius: 20px; text-align: center; width: 80%; max-width: 300px; }
        .pin-input { background: #000; border: 1px solid #333; color: white; width: 100%; padding: 12px; border-radius: 10px; text-align: center; font-size: 18px; margin: 15px 0; outline: none; }

        /* 2. Header (保持簡潔，點擊標題切換) */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; border-bottom: 1px solid #2c2c2e; cursor: pointer; }
        .header h2 { margin: 0; font-size: 18px; color: var(--danger); text-transform: uppercase; }
        .view-indicator { font-size: 11px; background: #333; padding: 2px 8px; border-radius: 10px; color: #8e8e93; }

        /* 3. Content Switcher (切換編輯器與 App 管理) */
        #view-editor, #view-apps { height: calc(100vh - 180px); overflow-y: auto; margin-top: 15px; }
        #view-apps { display: none; }

        /* 編輯器樣式 (強化版) */
        #json-editor { width: 100%; height: 300px; background: #000; color: var(--code); border: 1px solid #333; border-radius: 12px; padding: 12px; font-family: monospace; font-size: 13px; box-sizing: border-box; outline: none; resize: none; }
        .storage-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag { background: #2c2c2e; color: #8e8e93; padding: 5px 12px; border-radius: 15px; font-size: 11px; cursor: pointer; transition: 0.2s; }
        .tag.active { background: var(--primary); color: white; }

        /* App 管理樣式 (還原你稱讚的版本) */
        .app-item { background: var(--card-bg); border: 1px solid #2c2c2e; border-radius: 15px; padding: 12px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; }
        .app-icon { width: 40px; height: 40px; background: #333; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; color: var(--primary); }
        .app-info { flex: 1; }
        .app-name { font-size: 14px; font-weight: bold; }
        .app-id { font-size: 11px; color: #666; }
        .app-actions { display: flex; gap: 5px; }
        .ctrl-btn { padding: 6px 10px; background: #2c2c2e; border-radius: 8px; font-size: 12px; color: #fff; cursor: pointer; }
        .ctrl-del { color: var(--danger); }

        /* 4. Action Bar (固定底部) */
        .action-bar { position: fixed; bottom: 20px; left: 10px; right: 10px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .btn { padding: 15px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; text-align: center; font-size: 14px; }
        .btn-reset { background: #3a3a3c; color: #fff; }
        .btn-apply { background: var(--code); color: #000; }
        .btn-respring { background: var(--danger); color: #fff; }
    </style>
</head>
<body>

    <div id="check-screen"><div class="spinner"></div></div>

    <div id="auth-overlay">
        <div class="auth-card">
            <h1>Root Debugger</h1>
            <input type="password" id="auth-pin" class="pin-input" placeholder="••••">
            <button class="btn btn-apply" style="width:100%" onclick="checkAuth()">Authenticate</button>
        </div>
    </div>

    <div class="header" onclick="toggleView()">
        <h2 id="header-text">Root Debugger</h2>
        <div class="view-indicator" id="view-mode">EDITOR MODE</div>
    </div>

    <div id="view-editor">
        <textarea id="json-editor" spellcheck="false" oninput="cacheCurrentInput()"></textarea>
        <div class="storage-tags" id="storage-tags"></div>
    </div>

    <div id="view-apps">
        <div id="app-list-container"></div>
    </div>

    <div class="action-bar">
        <div class="btn btn-reset" onclick="resetToSystem()">Reset</div>
        <div class="btn btn-apply" onclick="saveToSystem()">Apply</div>
        <div class="btn btn-respring" onclick="respring()">Respring</div>
    </div>

    <script>
        let currentKey = "devicePasscode";
        let memoryCache = {}; // 暫存所有 Key 的改動，避免切換時丟失
        let appsData = [];

        window.onload = function() {
            setTimeout(() => {
                document.getElementById('check-screen').style.display = 'none';
                document.getElementById('auth-overlay').style.display = 'flex';
                initDebugger();
            }, 1000);
        };

        function checkAuth() {
            if(document.getElementById('auth-pin').value === (localStorage.getItem('devicePasscode') || "")) {
                document.getElementById('auth-overlay').style.display = 'none';
            }
        }

        function initDebugger() {
            // 1. 將 localStorage 載入 memoryCache
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                memoryCache[k] = localStorage.getItem(k);
            }
            // 2. 獨立處理 Apps
            appsData = JSON.parse(memoryCache['installedApps'] || '[]');
            
            renderTags();
            loadKeyToEditor(currentKey);
            renderAppManager();
        }

        // 切換視圖 (編輯器 <-> App 管理)
        function toggleView() {
            const vEditor = document.getElementById('view-editor');
            const vApps = document.getElementById('view-apps');
            const indicator = document.getElementById('view-mode');
            
            if (vEditor.style.display !== 'none') {
                vEditor.style.display = 'none';
                vApps.style.display = 'block';
                indicator.innerText = "APP MANAGER";
                renderAppManager(); // 切換時刷新列表
            } else {
                vEditor.style.display = 'block';
                vApps.style.display = 'none';
                indicator.innerText = "EDITOR MODE";
            }
        }

        // --- 編輯器邏輯 ---
        function renderTags() {
            const container = document.getElementById('storage-tags');
            container.innerHTML = "";
            Object.keys(memoryCache).forEach(k => {
                const tag = document.createElement('span');
                tag.className = 'tag' + (k === currentKey ? ' active' : '');
                tag.innerText = k;
                tag.onclick = (e) => { e.stopPropagation(); loadKeyToEditor(k); };
                container.appendChild(tag);
            });
        }

        function loadKeyToEditor(key) {
            currentKey = key;
            const val = memoryCache[key] || "";
            try { document.getElementById('json-editor').value = JSON.stringify(JSON.parse(val), null, 4); }
            catch(e) { document.getElementById('json-editor').value = val; }
            renderTags();
        }

        function cacheCurrentInput() {
            memoryCache[currentKey] = document.getElementById('json-editor').value;
            if(currentKey === 'installedApps') {
                try { appsData = JSON.parse(memoryCache[currentKey]); } catch(e){}
            }
        }

        // --- App 管理邏輯 (復原你滿意的版本) ---
        function renderAppManager() {
            const container = document.getElementById('app-list-container');
            container.innerHTML = "";
            appsData.forEach((app, idx) => {
                const item = document.createElement('div');
                item.className = 'app-item';
                item.innerHTML = `
                    <div class="app-icon">${app.name[0]}</div>
                    <div class="app-info">
                        <div class="app-name">${app.name}</div>
                        <div class="app-id">${app.id}</div>
                    </div>
                    <div class="app-actions">
                        <div class="ctrl-btn" onclick="moveApp(${idx},-1)">▲</div>
                        <div class="ctrl-btn" onclick="moveApp(${idx},1)">▼</div>
                        <div class="ctrl-btn ctrl-del" onclick="deleteApp(${idx})">✕</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function moveApp(idx, dir) {
            let target = idx + dir;
            if(target >= 0 && target < appsData.length) {
                [appsData[idx], appsData[target]] = [appsData[target], appsData[idx]];
                syncAppsBackToCache();
            }
        }

        function deleteApp(idx) {
            if(confirm("Delete App Package?")) {
                appsData.splice(idx, 1);
                syncAppsBackToCache();
            }
        }

        function syncAppsBackToCache() {
            memoryCache['installedApps'] = JSON.stringify(appsData);
            if(currentKey === 'installedApps') loadKeyToEditor('installedApps');
            renderAppManager();
        }

        // --- 底部按鈕動作 ---
        function resetToSystem() {
            if(confirm("Discard all local changes?")) location.reload();
        }

        function saveToSystem() {
            Object.keys(memoryCache).forEach(k => localStorage.setItem(k, memoryCache[k]));
            alert("✅ Root data synchronized.");
        }

        function respring() {
            window.top.location.replace('./install');
        }
    </script>
</body>
</html>
