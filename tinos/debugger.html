<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Root Debugger</title>
    <style>
        :root { --primary: #007aff; --bg: #000; --card: #1c1c1e; --text: #fff; --code: #32d74b; --danger: #ff3b30; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* å°èˆªæ¬„ */
        .nav-tabs { display: flex; background: #121212; border-bottom: 1px solid #2c2c2e; z-index: 100; }
        .tab { flex: 1; padding: 15px; text-align: center; font-size: 13px; color: #8e8e93; cursor: pointer; }
        .tab.active { color: var(--text); border-bottom: 2px solid var(--primary); background: var(--card); }

        .content { flex: 1; overflow-y: auto; padding: 20px; display: none; padding-bottom: 100px; }
        .content.active { display: block; }

        /* ç·¨è¼¯å™¨å¼·åŒ–ç‰ˆ */
        .editor-container { display: flex; flex-direction: column; gap: 10px; }
        .header-info { display: flex; justify-content: space-between; align-items: center; color: var(--danger); font-size: 14px; font-weight: bold; }
        #main-textarea { width: 100%; height: 320px; background: #000; color: var(--code); border: 1px solid #333; border-radius: 12px; padding: 15px; font-family: 'Courier New', monospace; font-size: 13px; box-sizing: border-box; outline: none; }
        .storage-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag { background: #2c2c2e; color: #8e8e93; padding: 6px 12px; border-radius: 15px; font-size: 11px; cursor: pointer; border: 1px solid transparent; }
        .tag.active { border-color: var(--primary); color: var(--primary); background: rgba(0,122,255,0.1); }

        /* Apps ç®¡ç†å™¨ (æ¢å¾©å®Œæ•´è¨­è¨ˆ) */
        .app-card { background: var(--card); border: 1px solid #2c2c2e; border-radius: 15px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; gap: 15px; }
        .app-icon { width: 45px; height: 45px; background: #333; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .app-details { flex: 1; }
        .app-name { font-weight: bold; font-size: 15px; }
        .app-id { font-size: 11px; color: #666; }
        .app-actions { display: flex; gap: 8px; }
        .action-btn { background: #2c2c2e; border: none; color: #fff; padding: 8px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; }
        .del-btn { color: var(--danger); }

        /* åº•éƒ¨æŒ‰éˆ• */
        .footer { position: fixed; bottom: 0; width: 100%; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; padding: 15px; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); box-sizing: border-box; }
        .btn { padding: 15px; border: none; border-radius: 12px; font-weight: bold; font-size: 14px; cursor: pointer; text-align: center; }
        .btn-reset { background: #3a3a3c; color: white; }
        .btn-apply { background: #32d74b; color: black; }
        .btn-respring { background: var(--danger); color: white; }

        /* éš±è—åŸç”Ÿ Loading */
        #loading { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="loading">
        <div style="text-align: center;">
            <div style="width: 30px; height: 30px; border: 3px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="font-size: 12px; color: #666; margin-top: 10px;">Root Debugger Initializing...</p>
        </div>
    </div>

    <div class="nav-tabs">
        <div class="tab active" onclick="showTab('editor')">ç·¨è¼¯å™¨</div>
        <div class="tab" onclick="showTab('apps')">Apps ç®¡ç†</div>
        <div class="tab" onclick="showTab('menu')">é¸å–®</div>
    </div>

    <div id="editor-page" class="content active">
        <div class="editor-container">
            <div class="header-info">KEY: <span id="active-key-name">devicePasscode</span></div>
            <textarea id="main-textarea" spellcheck="false" oninput="saveToCache()"></textarea>
            <div class="storage-tags" id="tag-list"></div>
        </div>
    </div>

    <div id="apps-page" class="content">
        <div class="header-info">APP ENCAPSULATION MANAGER</div>
        <div id="app-list-container" style="margin-top: 15px;"></div>
    </div>

    <div id="menu-page" class="content">
        <div class="app-card" onclick="showTab('editor')">ğŸ› ï¸ ç³»çµ±æ ¸å¿ƒæ•¸æ“šç·¨è¼¯å™¨</div>
        <div class="app-card" onclick="showTab('apps')">ğŸ“¦ æ‡‰ç”¨ç¨‹å¼å°è£èˆ‡æ’åºç®¡ç†</div>
        <div class="app-card" style="opacity: 0.5;">ğŸ–¼ï¸ èƒŒæ™¯åœ–ç‰‡ç®¡ç† (é–‹ç™¼ä¸­)</div>
    </div>

    <div class="footer">
        <button class="btn btn-reset" onclick="initDebugger()">é‡è¨­</button>
        <button class="btn btn-apply" onclick="applyChanges()">å¥—ç”¨</button>
        <button class="btn btn-respring" onclick="respring()">é‡åˆ·</button>
    </div>

    <script>
        let currentKey = "devicePasscode";
        let tempStorage = {};
        let installedApps = [];

        window.onload = function() {
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                initDebugger();
            }, 800);
        };

        function initDebugger() {
            // è®€å–æ‰€æœ‰ Key åˆ°æš«å­˜
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                tempStorage[k] = localStorage.getItem(k);
            }
            
            // ç¢ºä¿ installedApps æ­£ç¢ºè®€å–
            const appsData = localStorage.getItem('installedApps');
            installedApps = appsData ? JSON.parse(appsData) : [];

            renderTags();
            loadEditorContent(currentKey);
            renderAppManager();
        }

        // --- ç·¨è¼¯å™¨åŠŸèƒ½ ---
        function renderTags() {
            const list = document.getElementById('tag-list');
            list.innerHTML = "";
            Object.keys(tempStorage).forEach(k => {
                const span = document.createElement('span');
                span.className = 'tag' + (k === currentKey ? ' active' : '');
                span.innerText = k;
                span.onclick = () => switchKey(k);
                list.appendChild(span);
            });
        }

        function switchKey(key) {
            currentKey = key;
            document.getElementById('active-key-name').innerText = key;
            loadEditorContent(key);
            renderTags();
        }

        function loadEditorContent(key) {
            const val = tempStorage[key] || "";
            try {
                document.getElementById('main-textarea').value = JSON.stringify(JSON.parse(val), null, 4);
            } catch(e) {
                document.getElementById('main-textarea').value = val;
            }
        }

        function saveToCache() {
            tempStorage[currentKey] = document.getElementById('main-textarea').value;
            // å¦‚æœç·¨è¼¯çš„æ˜¯ appsï¼ŒåŒæ­¥æ›´æ–°ç®¡ç†ä»‹é¢
            if(currentKey === 'installedApps') {
                try { installedApps = JSON.parse(tempStorage[currentKey]); renderAppManager(); } catch(e){}
            }
        }

        // --- Apps ç®¡ç†åŠŸèƒ½ (å¾©åŸè¨­è¨ˆ) ---
        function renderAppManager() {
            const container = document.getElementById('app-list-container');
            container.innerHTML = "";
            installedApps.forEach((app, index) => {
                const div = document.createElement('div');
                div.className = 'app-card';
                div.innerHTML = `
                    <div class="app-icon">${app.name.charAt(0).toUpperCase()}</div>
                    <div class="app-details">
                        <div class="app-name">${app.name}</div>
                        <div class="app-id">${app.id}</div>
                    </div>
                    <div class="app-actions">
                        <button class="action-btn" onclick="moveApp(${index}, -1)">â–²</button>
                        <button class="action-btn" onclick="moveApp(${index}, 1)">â–¼</button>
                        <button class="action-btn del-btn" onclick="deleteApp(${index})">âœ•</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function moveApp(idx, step) {
            const target = idx + step;
            if(target >= 0 && target < installedApps.length) {
                const temp = installedApps[idx];
                installedApps[idx] = installedApps[target];
                installedApps[target] = temp;
                tempStorage['installedApps'] = JSON.stringify(installedApps);
                if(currentKey === 'installedApps') loadEditorContent('installedApps');
                renderAppManager();
            }
        }

        function deleteApp(idx) {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤æ‡‰ç”¨ç¨‹å¼å°è£ï¼Ÿ")) {
                installedApps.splice(idx, 1);
                tempStorage['installedApps'] = JSON.stringify(installedApps);
                if(currentKey === 'installedApps') loadEditorContent('installedApps');
                renderAppManager();
            }
        }

        // --- é€šç”¨åŠŸèƒ½ ---
        function showTab(tab) {
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tab + '-page').classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function applyChanges() {
            Object.keys(tempStorage).forEach(k => {
                localStorage.setItem(k, tempStorage[k]);
            });
            alert("âœ… ç³»çµ±æ•¸æ“šå·²æˆåŠŸå¯«å…¥å¯¦é«”å­˜å„²å±¤");
        }

        function respring() {
            window.top.location.replace('./install');
        }
    </script>
    <style> @keyframes spin { to { transform: rotate(360deg); } } </style>
</body>
</html>
