<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>TNTExplorer 探索器</title>

  <style>
    :root{
      --orange:#ED732E; --black:#000; --white:#ffffff; --muted:#bbb;
      --green:#28a745; --red:#dc3545; --blue:#007bff; --yellow:#ffd400;
      --panel-bg: rgba(0,0,0,0.92); --overlay-bg: rgba(0,0,0,0.75);
      --input-bg: #ffffff; --input-color: #111; --card-bg: rgba(255,255,255,0.03);
      --body-bg-mid: #ffffff; /* 網頁中間背景色 */
    }

    @media (prefers-color-scheme: dark) {
      :root{
        --input-bg: #1b1b1b;
        --input-color: #e6e6e6;
        --panel-bg: rgba(12,12,12,0.98);
        --overlay-bg: rgba(0,0,0,0.85);
        --card-bg: rgba(255,255,255,0.02);
        --muted: #9f9f9f;
        --body-bg-mid: #1a1a1a; /* 深色模式下的中間背景 */
      }
    }

    html,body{height:100%;margin:0;padding:0;overflow-x:hidden;font-family:Arial, sans-serif;-webkit-text-size-adjust:100%;}
    body{display:flex;align-items:center;justify-content:center;
      /* 修正：深色模式下中間白色部分也會變深 */
      background:linear-gradient(to bottom, var(--orange) 0%, var(--orange) 20%, var(--body-bg-mid) 20%, var(--body-bg-mid) 80%, var(--orange) 80%, var(--orange) 100%);
    }

    .search-container{background:var(--black);color:var(--white);width:min(92%,420px);padding:20px 28px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.5);text-align:center;z-index:1}
    .search-container h1{font-size:26px;margin:0 0 6px}
    .subtitle{font-size:14px;margin:0 0 16px;opacity:.85;font-style:italic}
    .engine-select{margin-bottom:10px;text-align:left}
    .engine-select select{width:100%;padding:8px;border-radius:6px;border:none;font-size:15px;background:var(--input-bg);color:var(--input-color)}
    .search-row{display:flex;align-items:center;gap:8px;margin-bottom:10px}
    .search-row input[type="text"]{flex:1;padding:10px;font-size:15px;border-radius:8px;border:1px solid #ddd;outline:none;background:var(--input-bg);color:var(--input-color)}
    #historyButton{width:40px;height:40px;background:var(--yellow);border:none;border-radius:6px;cursor:pointer;font-size:18px}
    .button-row{display:flex;gap:8px;margin-bottom:10px}
    .button-row button{flex:1;padding:10px;border-radius:8px;border:none;cursor:pointer;font-size:15px}
    #translateButton{background:var(--green);color:#fff}#goButton{background:#0073e6;color:#fff}
    #archiveButton{width:100%;padding:12px;border-radius:8px;border:none;background:var(--red);color:#fff;cursor:pointer}

    .overlay{display:none;position:fixed;inset:0;background:var(--overlay-bg);align-items:center;justify-content:center;z-index:1000;overflow:auto}
    .overlay.active{display:flex}
    .panel{background:var(--panel-bg);color:var(--white);padding:16px;border-radius:8px;width:min(94%,560px);max-width:560px;max-height:90vh;overflow:auto;box-sizing:border-box}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px}
    .left-controls{display:flex;gap:8px;align-items:center}
    .btn-gray{background:#6c757d;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}
    .btn-white{background:#fff;color:#000;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}
    .btn-yellow{background:var(--yellow);color:#000;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}
    .btn-red{background:var(--red);color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}
    .btn-blue{background:var(--blue);color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}
    .menu-select{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--white);padding:6px 8px;border-radius:6px}
    .panel .title{font-size:18px;font-weight:700}
    .description{color:var(--muted);font-size:14px;margin-bottom:10px}

    .bookmark-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .bookmark-card{background:var(--card-bg);padding:8px;border-radius:8px;display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;position:relative;min-height:84px;transition:all .12s}
    .bookmark-card img{width:44px;height:44px;border-radius:8px;object-fit:cover;background:#333}
    .bookmark-name{font-size:12px;color:var(--white);text-align:center;word-break:break-word}
    .bookmark-actions{display:flex;gap:6px;margin-top:6px}
    .btn-edit-bookmark{background:#6c757d;color:#fff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer}
    
    /* 修正外框邏輯：編輯為藍色，清除為紅色 */
    .bookmark-card.editing-mark{outline:3px solid var(--blue); box-shadow:0 0 0 4px rgba(0,123,255,0.3)}
    .bookmark-card.selected{outline:3px solid var(--red); box-shadow:0 0 0 4px rgba(220,53,69,0.3)}
    .bookmark-card.clear-icon-mode-mark{outline:3px solid var(--red) !important;}

    .remove-controls{display:flex;align-items:center;gap:10px;margin:10px 0}
    .count-badge{background:var(--green);color:#fff;padding:6px 10px;border-radius:8px;font-weight:700}

    .add-form{display:flex;flex-direction:column;gap:8px;padding:8px;border-radius:6px;background:rgba(255,255,255,0.02);margin-bottom:8px}
    .add-form input[type="text"],.add-form input[type="file"]{padding:8px;border-radius:6px;border:1px solid #ddd;color:var(--input-color);background:var(--input-bg)}
    .add-actions{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:6px}
    .btn-white.clear-mode { background: var(--red); color: #fff; outline: 2px solid var(--white); }

    .fetch-popup{position:fixed;left:50%;transform:translateX(-50%);top:12px;background:rgba(0,0,0,0.85);color:#fff;padding:8px 12px;border-radius:8px;z-index:2000;font-size:14px;pointer-events:none;display:none;}
    @media (max-width:420px){ .bookmark-grid{grid-template-columns:repeat(4,1fr)} .bookmark-card img{width:36px;height:36px} .panel{padding:12px} }
  </style>
</head>
<body>
  <div class="fetch-popup" id="fetchPopup">正在抓取網站圖示</div>

  <div class="search-container">
    <h1>TNTExplorer 探索器</h1>
    <div class="subtitle">由TNH Minecraft負責監督，Gemini負責實行</div>

    <div class="engine-select">
      <select id="engine">
        <option value="https://www.google.com/search?num=70&udm=14&q=%s">Google</option>
        <option value="https://www.bing.com/search?q=%s">Bing</option>
        <option value="https://www.youtube.com/results?search_query=%s">YouTube</option>
        <option value="https://www.reddit.com/search/?q=%s">Reddit</option>
      </select>
    </div>

    <form id="searchForm">
      <div class="search-row">
        <input type="text" id="query" placeholder="請輸入查詢或網址…" autocomplete="off"/>
        <button type="button" id="historyButton">⧆</button>
      </div>
      <div class="button-row">
        <button type="button" id="translateButton">翻譯</button>
        <button type="button" id="goButton">前往</button>
      </div>
    </form>
    <button id="archiveButton">查看舊版網頁</button>
  </div>

  <div id="overlay" class="overlay">
    <div class="panel">
      <div class="topbar">
        <div class="left-controls">
          <button id="closePanel" class="btn-gray">關閉</button>
          <select id="panelMenu" class="menu-select">
            <option value="bookmarks">書籤</option>
            <option value="records">探索記錄</option>
          </select>
          <button id="toggleEditBtn" class="btn-gray">編輯</button>
          <button id="clearIconBtn" class="btn-white" style="display:none">清除圖示</button>
          <button id="addModeBtn" class="btn-yellow">新增</button>
        </div>
        <div class="title" id="panelTitle">書籤</div>
      </div>

      <div id="bookmarksView">
        <div id="addForm" class="add-form" style="display:none">
          <input type="file" id="iconFile" accept="image/*"/>
          <input type="text" id="bookmarkName" placeholder="輸入書籤名"/>
          <input type="text" id="bookmarkURL" placeholder="輸入書籤網址"/>
          <div class="add-actions">
            <button id="cancelAdd" class="btn-gray">返回</button>
            <button id="confirmAdd" class="btn-yellow">新增</button>
          </div>
        </div>
        <div id="removeControls" style="display:none" class="remove-controls">
          <div class="count-badge" id="selectedCount">0</div>
          <button id="removeSelected" class="btn-red">移除所選</button>
        </div>
        <div id="bookmarkGrid" class="bookmark-grid"></div>
      </div>
      <div id="recordsView" style="display:none"><div id="recordsList"></div></div>
    </div>
  </div>

  <div style="position:fixed;left:0;right:0;bottom:18px;text-align:center;color:#fff;font-size:14px;z-index:1">
    <a href="https://www.threads.net/@tnh_minecraft_lost" target="_blank" style="color:#fff;text-decoration:none">支持作者</a>
    <div style="font-size:13px;margin-top:6px">版本號: 0.8.2</div>
  </div>

  <script>
    const STORAGE = { RECORDS: 'tntExplorerHistory', BOOKMARKS: 'tnt_explore_bookmarks', ENGINE: 'tnt_preferred_engine' };

    function loadJSON(key){ try{ return JSON.parse(localStorage.getItem(key) || '[]'); }catch(e){ return []; } }
    function saveJSON(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
    function uid(){ return 'id_' + Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
    function normalizeKey(s){ return (s||'').trim().toLowerCase(); }
    function isLikelyURL(s){ return /(:\/\/)|(^(?!\.)\S+\.[^\s]+$)/i.test(s) }

    const overlay = document.getElementById('overlay');
    const engineSelect = document.getElementById('engine');
    const queryInput = document.getElementById('query');
    const bookmarkGrid = document.getElementById('bookmarkGrid');
    const toggleEditBtn = document.getElementById('toggleEditBtn');
    const clearIconBtn = document.getElementById('clearIconBtn');
    const addModeBtn = document.getElementById('addModeBtn');
    const addForm = document.getElementById('addForm');
    const bookmarkName = document.getElementById('bookmarkName');
    const bookmarkURL = document.getElementById('bookmarkURL');
    const selectedCount = document.getElementById('selectedCount');

    let removeMode = false, addMode = false, editMode = false, clearIconMode = false, editTargetId = null;
    const selectedBookmarks = new Set();

    // 儲存搜尋引擎偏好
    engineSelect.addEventListener('change', () => localStorage.setItem(STORAGE.ENGINE, engineSelect.value));

    async function fetchFavicon(url){
      const dest = url.match(/^https?:\/\//i) ? url : ('https://' + url);
      try {
        const host = new URL(dest).hostname;
        const src = `https://www.google.com/s2/favicons?domain=${host}&sz=128`;
        const r = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(src)}`);
        if(r.ok) return await blobToDataURL(await r.blob());
      } catch(e){}
      return null;
    }
    function blobToDataURL(blob){ return new Promise(res => { const fr = new FileReader(); fr.onload = () => res(fr.result); fr.readAsDataURL(blob); }); }

    function renderBookmarks(){
      const arr = loadJSON(STORAGE.BOOKMARKS);
      bookmarkGrid.innerHTML = '';
      arr.forEach(b => {
        const card = document.createElement('div'); card.className = 'bookmark-card';
        if(editMode && b.id === editTargetId) card.classList.add(clearIconMode ? 'clear-icon-mode-mark' : 'editing-mark');
        if(removeMode && selectedBookmarks.has(b.id)) card.classList.add('selected');

        const img = document.createElement('img'); img.src = b.icon || '';
        const name = document.createElement('div'); name.className = 'bookmark-name'; name.textContent = b.name;
        
        card.onclick = () => {
          if(addMode) { bookmarkName.value = b.name; return; }
          if(removeMode) {
            selectedBookmarks.has(b.id) ? selectedBookmarks.delete(b.id) : selectedBookmarks.add(b.id);
            renderBookmarks(); selectedCount.textContent = selectedBookmarks.size; return;
          }
          if(b.url) window.open(b.url.match(/^https?:\/\//i) ? b.url : 'https://'+b.url, '_blank');
        };

        const editBtn = document.createElement('button'); editBtn.className = 'btn-edit-bookmark'; editBtn.textContent = '編輯';
        editBtn.style.display = removeMode ? 'block' : 'none';
        editBtn.onclick = (e) => { e.stopPropagation(); enterEditMode(b.id); };

        card.append(img, name, editBtn); bookmarkGrid.appendChild(card);
      });
    }

    function enterEditMode(id){
      const b = loadJSON(STORAGE.BOOKMARKS).find(x => x.id === id);
      editMode = true; editTargetId = id; addMode = true; removeMode = false;
      addForm.style.display = 'flex'; toggleEditBtn.style.display = 'none'; clearIconBtn.style.display = 'inline-block';
      bookmarkName.value = b.name; bookmarkURL.value = b.url;
      document.getElementById('confirmAdd').textContent = '儲存';
      renderBookmarks();
    }

    function exitAllModes(){
      editMode = false; addMode = false; removeMode = false; clearIconMode = false; editTargetId = null;
      addForm.style.display = 'none'; toggleEditBtn.style.display = 'inline-block'; clearIconBtn.style.display = 'none';
      toggleEditBtn.className = 'btn-gray'; toggleEditBtn.textContent = '編輯';
      document.getElementById('removeControls').style.display = 'none';
      renderBookmarks();
    }

    toggleEditBtn.onclick = () => {
      if(!removeMode) {
        removeMode = true; toggleEditBtn.textContent = '完成'; toggleEditBtn.className = 'btn-blue';
        document.getElementById('removeControls').style.display = 'flex';
        selectedBookmarks.clear(); renderBookmarks();
      } else { exitAllModes(); }
    };

    clearIconBtn.onclick = () => { clearIconMode = !clearIconMode; clearIconBtn.classList.toggle('clear-mode'); renderBookmarks(); };
    document.getElementById('cancelAdd').onclick = exitAllModes;
    document.getElementById('closePanel').onclick = () => { overlay.classList.remove('active'); exitAllModes(); };

    document.getElementById('confirmAdd').onclick = async () => {
      const name = bookmarkName.value.trim(), url = bookmarkURL.value.trim();
      if(!name || !url) return;
      let arr = loadJSON(STORAGE.BOOKMARKS);
      let icon = (editMode && !clearIconMode) ? arr.find(x=>x.id===editTargetId).icon : await fetchFavicon(url);
      
      if(editMode) arr = arr.map(x => x.id === editTargetId ? {...x, name, url, icon} : x);
      else arr.push({id: uid(), name, url, icon});
      
      saveJSON(STORAGE.BOOKMARKS, arr); exitAllModes();
    };

    // 初始化：載入搜尋引擎偏好
    function init(){
      const savedEngine = localStorage.getItem(STORAGE.ENGINE);
      if(savedEngine) engineSelect.value = savedEngine;
      renderBookmarks();
    }

    document.getElementById('historyButton').onclick = () => { overlay.classList.add('active'); renderBookmarks(); };
    document.getElementById('goButton').onclick = () => {
      const v = queryInput.value.trim(); if(!v) return;
      window.open(isLikelyURL(v) ? (v.match(/^https?:\/\//i) ? v : 'https://'+v) : engineSelect.value.replace('%s', encodeURIComponent(v)), '_blank');
    };

    init();
  </script>
</body>
</html>
