<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>TNTExplorer 探索器</title>
  <link rel="icon" href="https://tnttc2.github.io/iog.github.io/TNTExplorer/icon.jpeg" type="image/jpeg"/>
  <link rel="apple-touch-icon" href="https://tnttc2.github.io/iog.github.io/TNTExplorer/icon.jpeg"/>
  <style>
    :root{
      --orange:#ED732E; --black:#000; --white:#fff; --muted:#bbb;
      --green:#28a745; --red:#dc3545; --blue:#007bff; --yellow:#ffd400;
      --panel-bg: rgba(0,0,0,0.92); --overlay-bg: rgba(0,0,0,0.75);
    }
    @media (prefers-color-scheme: dark) {
      :root{ --white:#e6e6e6; --muted:#c2c2c2; --panel-bg: rgba(18,18,18,0.98); --overlay-bg: rgba(0,0,0,0.85); }
      body { background: linear-gradient(to bottom, #b95a20 0%, #b95a20 20%, #2f2f2f 20%, #2f2f2f 80%, #b95a20 80%, #b95a20 100%); }
    }

    html,body{height:100%;margin:0;padding:0;box-sizing:border-box;font-family:Arial, sans-serif;-webkit-text-size-adjust:100%;}
    body{
      background: linear-gradient(to bottom, var(--orange) 0%, var(--orange)20%, var(--white)20%, var(--white)80%, var(--orange)80%, var(--orange)100%);
      display:flex;align-items:center;justify-content:center;position:relative;overflow-x:hidden;
    }

    /* 主介面（維持 0.6.3） */
    .search-container{background:#000;color:var(--white);width:90%;max-width:400px;padding:20px 30px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.5);text-align:center;z-index:1;}
    .search-container h1{font-size:28px;margin:0 0 5px;}
    .subtitle{font-size:16px;margin:0 0 20px;opacity:0.8;font-style:italic;}
    .engine-select{ text-align:left;margin-bottom:12px;}
    .engine-select select{ width:100%;padding:8px;font-size:16px;border:none;border-radius:6px;outline:none;}
    .search-row{display:flex;align-items:center;margin-bottom:10px;}
    .search-row input[type="text"]{flex:1;padding:10px;font-size:16px;border:none;border-radius:8px;outline:none;background:#111;color:var(--white);}
    /* prevent mobile zoom by using font-size >=16px above and meta viewport */
    #historyButton{width:40px;height:40px;margin-left:5px;background:var(--yellow);border:none;border-radius:5px;cursor:pointer;font-size:18px;line-height:1;}
    .button-row{display:flex;justify-content:space-between;margin-bottom:10px;}
    .button-row button{width:48%;padding:10px;font-size:16px;border:none;border-radius:8px;cursor:pointer;}
    #translateButton{background:var(--green);color:#fff;}#translateButton:hover{background:#218838;}
    #goButton{background:#0073e6;color:#fff;}#goButton:hover{background:#005bb5;}
    #archiveButton{width:100%;padding:12px;font-size:16px;border:none;border-radius:8px;background:var(--red);color:#fff;cursor:pointer;}
    #archiveButton:hover{background:#c82333;}

    /* overlay panel (max-width restored to 500px) */
    .overlay{display:none;position:fixed;inset:0;background:var(--overlay-bg);align-items:center;justify-content:center;z-index:1000;}
    .overlay.active{display:flex;}
    .panel{background:var(--panel-bg);color:var(--white);padding:18px;border-radius:8px;width:90%;max-width:500px;max-height:92vh;overflow:auto;box-sizing:border-box;}

    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:8px;}
    .left-controls{display:flex;gap:8px;align-items:center;}
    .btn-gray{background:#fff;color:#000;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;} /* white return button style uses same class for top-return */
    .btn-white{background:#fff;color:#000;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;}
    .btn-yellow{background:var(--yellow);color:#000;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;}
    .btn-red{background:var(--red);color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;}
    .btn-blue{background:var(--blue);color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;}

    .menu-select{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--white);padding:6px 8px;border-radius:6px;}
    .panel .title{font-size:18px;font-weight:700;}

    .description{color:var(--muted);font-size:14px;margin-bottom:10px;}

    /* records */
    #recordsView .record-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,0.03);margin-bottom:8px;word-break:break-word;}
    #recordsView .record-item .text{color:var(--white);flex:1;margin-right:10px;text-align:left;cursor:pointer;}

    /* bookmarks: smaller icons to allow 4-per-row on mobile */
    .bookmark-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
    .bookmark-card{background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;position:relative;min-height:90px;}
    .bookmark-card img{width:48px;height:48px;border-radius:8px;object-fit:cover;background:#333;}
    .bookmark-name{font-size:12px;color:var(--white);text-align:center;word-break:break-word;}
    .bookmark-card .select-checkbox{position:absolute;top:6px;right:6px;width:16px;height:16px;border-radius:4px;border:2px solid rgba(255,255,255,0.6);display:none;align-items:center;justify-content:center;color:#fff;font-weight:bold;}
    .bookmark-card.select-mode .select-checkbox{display:flex;}
    .bookmark-card.selected{outline:3px solid var(--red);}

    .remove-controls{display:flex;align-items:center;gap:10px;margin:8px 0;}
    .count-badge{background:var(--green);color:#fff;padding:6px 10px;border-radius:8px;font-weight:700;}

    /* add form vertical */
    .add-form{display:flex;flex-direction:column;gap:8px;padding:6px;border-radius:6px;background:rgba(255,255,255,0.02);margin-bottom:8px;}
    .add-form input[type="text"], .add-form input[type="file"]{padding:8px;border-radius:6px;border:none;color:var(--white);background:rgba(255,255,255,0.03);font-size:14px;}

    /* responsive grid adjustments */
    @media (max-width:800px){ .bookmark-grid{grid-template-columns:repeat(4,1fr);} }
    @media (max-width:520px){ .bookmark-grid{grid-template-columns:repeat(4,1fr);} .search-container{max-width:360px;} }

    .footer{position:fixed;left:0;right:0;bottom:18px;text-align:center;color:var(--white);font-size:14px;z-index:1;}
    .footer a{color:var(--white);text-decoration:none;}
    .version{margin-top:6px;font-size:13px;color:var(--muted);}
  </style>
</head>
<body>
  <div class="search-container" id="mainUI">
    <h1>TNTExplorer 探索器</h1>
    <div class="subtitle">由TNH Minecraft負責監督，Copilot負責實行</div>

    <div class="engine-select" aria-hidden="true">
      <select id="engine">
        <option value="https://www.google.com/search?num=70&udm=14&q=%s" selected>Google</option>
        <option value="https://www.bing.com/search?q=%s">Bing</option>
        <option value="https://www.youtube.com/results?search_query=%s">YouTube</option>
        <option value="https://www.reddit.com/search/?q=%s">Reddit</option>
      </select>
    </div>

    <form id="searchForm">
      <div class="search-row">
        <input type="text" id="query" placeholder="請輸入查詢或網址…" autocomplete="off" inputmode="text" />
        <button type="button" id="historyButton" aria-label="探索與書籤">⧆</button>
      </div>
      <div class="button-row">
        <button type="button" id="translateButton">翻譯</button>
        <button type="button" id="goButton">前往</button>
      </div>
    </form>

    <button id="archiveButton">查看舊版網頁</button>
  </div>

  <!-- overlay panel -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="panelTitle">
      <div class="topbar">
        <div class="left-controls">
          <!-- top return button appears only in add-mode; default hidden -->
          <button id="topReturn" class="btn-white" style="display:none">返回</button>

          <select id="panelMenu" class="menu-select" aria-label="選單位置">
            <option value="bookmarks">書籤</option>
            <option value="records">探索記錄</option>
          </select>

          <!-- add/remove buttons: will be toggled (mutually exclusive) -->
          <button id="addModeToggle" class="btn-yellow">新增</button>
          <button id="removeModeToggle" class="btn-red">移除</button>
        </div>
        <div class="title" id="panelTitle">書籤</div>
      </div>

      <!-- single description line shown in records view -->
      <div id="panelDescription"><p id="exploreDesc" class="description" style="display:none">查看你的搜尋、翻譯、前往網站等紀錄</p></div>

      <!-- BOOKMARKS VIEW -->
      <div id="bookmarksView" class="content" style="display:block">
        <div class="muted" style="margin-bottom:6px">新增書籤須上傳圖示，否則無法新增</div>

        <!-- add form (vertical). topReturn shown when addMode true -->
        <div id="addForm" class="add-form" style="display:none">
          <input type="file" id="iconFile" accept="image/*"/>
          <input type="text" id="bookmarkName" placeholder="輸入書籤名"/>
          <input type="text" id="bookmarkURL" placeholder="輸入書籤網址"/>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:6px">
            <button id="cancelAdd" class="btn-gray">取消</button>
            <button id="confirmAdd" class="btn-yellow">新增</button>
          </div>
        </div>

        <!-- remove-mode controls -->
        <div id="removeControls" style="display:none" class="remove-controls">
          <div class="count-badge" id="selectedCount">0</div>
          <button id="removeSelected" class="btn-red">移除所選</button>
        </div>

        <div id="bookmarkGrid" class="bookmark-grid" aria-live="polite"></div>
      </div>

      <!-- RECORDS VIEW -->
      <div id="recordsView" class="content" style="display:none">
        <p id="recordsDescription" class="description" style="margin-top:0">查看你的搜尋、翻譯、前往網站等紀錄</p>
        <div id="recordsList"></div>
      </div>
    </div>
  </div>

  <div class="footer">
    <a href="https://www.youtube.com/@Minecraft_TryingTNH-db5pb" id="supportLink" target="_blank">支持作者</a>
    <div class="version">版本號: 0.7.1d</div>
  </div>

  <script>
    // storage keys
    const STORAGE = { RECORDS: 'tntExplorerHistory', BOOKMARKS: 'tnt_explore_bookmarks' };

    function loadJSON(key){ try{ return JSON.parse(localStorage.getItem(key) || '[]'); }catch{ return []; } }
    function saveJSON(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
    function uid(){ return 'id_' + Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
    function normalize(s){ return (s||'').trim().toLowerCase(); }
    function isLikelyURL(s){ return /(:\/\/)|(^(?!\.)\S+\.[^\s]+$)/i.test(s); }

    // UI refs
    const overlay = document.getElementById('overlay');
    const historyButton = document.getElementById('historyButton');
    const panelMenu = document.getElementById('panelMenu');
    const panelTitle = document.getElementById('panelTitle');
    const bookmarksView = document.getElementById('bookmarksView');
    const recordsView = document.getElementById('recordsView');
    const addModeToggle = document.getElementById('addModeToggle');
    const removeModeToggle = document.getElementById('removeModeToggle');
    const addForm = document.getElementById('addForm');
    const iconFile = document.getElementById('iconFile');
    const bookmarkName = document.getElementById('bookmarkName');
    const bookmarkURL = document.getElementById('bookmarkURL');
    const cancelAdd = document.getElementById('cancelAdd');
    const confirmAdd = document.getElementById('confirmAdd');
    const topReturn = document.getElementById('topReturn');
    const removeControls = document.getElementById('removeControls');
    const selectedCount = document.getElementById('selectedCount');
    const removeSelected = document.getElementById('removeSelected');
    const bookmarkGrid = document.getElementById('bookmarkGrid');
    const recordsList = document.getElementById('recordsList');
    const closePanelBtn = document.getElementById('closePanel');
    const exploreDesc = document.getElementById('exploreDesc');
    const engineSelect = document.getElementById('engine');
    const queryInput = document.getElementById('query');
    const goButton = document.getElementById('goButton');
    const translateButton = document.getElementById('translateButton');
    const archiveButton = document.getElementById('archiveButton');

    let addMode = false;
    let removeMode = false;
    let selectedBookmarks = new Set();

    /* ---------------------------
       Records: dedupe on add (case-insensitive), preserve new and remove old duplicates
       Stored as array of strings for compatibility with 0.6.3
       --------------------------- */
    function loadRecordsRaw(){ return loadJSON(STORAGE.RECORDS); }
    function saveRecordsRaw(arr){ saveJSON(STORAGE.RECORDS, arr); }

    function addRecord(text){
      if(!text || !text.trim()) return;
      const raw = loadRecordsRaw();
      // dedupe case-insensitive: remove any existing strings equal ignoring case
      const norm = normalize(text);
      const filtered = raw.filter(r => !(typeof r === 'string' && normalize(r) === norm));
      filtered.push(text);
      saveRecordsRaw(filtered);
    }

    function renderRecords(){
      const raw = loadRecordsRaw().slice().reverse();
      recordsList.innerHTML = '';
      if(raw.length === 0){ const el=document.createElement('div'); el.className='muted'; el.textContent=''; recordsList.appendChild(el); return; }
      raw.forEach(item=>{
        const text = (typeof item === 'string') ? item : (item && item.text) ? item.text : String(item);
        const row = document.createElement('div'); row.className='record-item';
        const t = document.createElement('div'); t.className='text'; t.textContent = text || '';
        // clicking any record fills query input (no direct navigation)
        t.addEventListener('click', () => {
          if(!text) return;
          queryInput.value = text;
          overlay.classList.remove('active'); overlay.setAttribute('aria-hidden','true');
        });
        const btn = document.createElement('button'); btn.className='btn-red'; btn.textContent='清除';
        btn.addEventListener('click', () => {
          const before = loadRecordsRaw();
          const idx = before.findIndex(r => (typeof r==='string' && r === item) || (r && r.text === (item.text||item)));
          if(idx !== -1){ before.splice(idx,1); saveRecordsRaw(before); renderRecords(); }
        });
        row.appendChild(t); row.appendChild(btn); recordsList.appendChild(row);
      });
    }

    /* ---------------------------
       Bookmarks
       --------------------------- */
    function loadBookmarks(){ return loadJSON(STORAGE.BOOKMARKS); }
    function saveBookmarks(arr){ saveJSON(STORAGE.BOOKMARKS, arr); }

    function addBookmark({name,url,icon}){
      if(!icon) return;
      const arr = loadBookmarks();
      const key = normalize(name + '|' + (url||''));
      const filtered = arr.filter(b => normalize(b.name + '|' + (b.url||'')) !== key);
      filtered.push({ id: uid(), name, url, icon });
      saveBookmarks(filtered);
    }

    function renderBookmarks(){
      const arr = loadBookmarks();
      bookmarkGrid.innerHTML = '';
      if(arr.length === 0){ const el = document.createElement('div'); el.className='muted'; el.textContent=''; bookmarkGrid.appendChild(el); return; }
      arr.forEach(b=>{
        const card = document.createElement('div'); card.className='bookmark-card'; card.dataset.id = b.id;
        const cb = document.createElement('div'); cb.className='select-checkbox'; cb.textContent='✓';
        const img = document.createElement('img'); img.alt = b.name||''; img.src = b.icon || '';
        const name = document.createElement('div'); name.className='bookmark-name'; name.textContent = b.name || '';
        card.appendChild(cb); card.appendChild(img); card.appendChild(name);

        card.addEventListener('click', () => {
          if(removeMode){
            if(selectedBookmarks.has(b.id)){ selectedBookmarks.delete(b.id); card.classList.remove('selected'); } else { selectedBookmarks.add(b.id); card.classList.add('selected'); }
            selectedCount.textContent = String(selectedBookmarks.size);
          } else {
            // navigate if url, else fill input
            if(b.url && b.url.trim()){
              const dest = b.url.match(/^https?:\/\//i) ? b.url : ('https://' + b.url);
              window.open(dest, '_blank');
            } else {
              queryInput.value = b.name || '';
              overlay.classList.remove('active'); overlay.setAttribute('aria-hidden','true');
            }
          }
        });

        if(removeMode) card.classList.add('select-mode'); else card.classList.remove('select-mode');
        if(selectedBookmarks.has(b.id)) card.classList.add('selected'); else card.classList.remove('selected');
        bookmarkGrid.appendChild(card);
      });
      selectedCount.textContent = String(selectedBookmarks.size || 0);
    }

    /* ---------------------------
       Panel open/close and view switching
       --------------------------- */
    function openPanel(defaultView='bookmarks'){ panelMenu.value = defaultView; switchView(defaultView); overlay.classList.add('active'); overlay.setAttribute('aria-hidden','false'); }
    function closePanel(){ overlay.classList.remove('active'); overlay.setAttribute('aria-hidden','true'); exitAddMode(); exitRemoveMode(); }
    historyButton.addEventListener('click', ()=> openPanel('bookmarks'));
    document.getElementById('panelMenu').addEventListener('change', (e)=> switchView(e.target.value));
    document.getElementById('closePanel').addEventListener('click', closePanel);
    overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closePanel(); });

    function switchView(view){
      // leaving panel closes modes
      exitAddMode(); exitRemoveMode();
      if(view === 'bookmarks'){
        bookmarksView.style.display = 'block';
        recordsView.style.display = 'none';
        panelTitle.textContent = '書籤';
        exploreDesc.style.display = 'none';
        addModeToggle.style.display = 'inline-block';
        removeModeToggle.style.display = 'inline-block';
        renderBookmarks();
      } else {
        bookmarksView.style.display = 'none';
        recordsView.style.display = 'block';
        panelTitle.textContent = '探索記錄';
        exploreDesc.style.display = 'block';
        addModeToggle.style.display = 'none';
        removeModeToggle.style.display = 'none';
        renderRecords();
      }
    }

    /* ---------------------------
       Add mode (top white "返回", bottom yellow "新增")
       - entering add mode hides remove button
       - exiting restores
       --------------------------- */
    addModeToggle.addEventListener('click', ()=>{
      if(!addMode) enterAddMode(); else exitAddMode();
    });
    topReturn.addEventListener('click', ()=> exitAddMode());
    cancelAdd.addEventListener('click', ()=> exitAddMode());
    function enterAddMode(){
      exitRemoveMode();
      addMode = true;
      addForm.style.display = 'flex';
      topReturn.style.display = 'inline-block'; /* white "返回" */
      addModeToggle.style.display = 'inline-block';
      addModeToggle.textContent = '完成'; /* bottom button label will be changed to "新增" on confirm */
      removeModeToggle.style.display = 'none';
      confirmAdd.textContent = '新增';
    }
    function exitAddMode(){
      addMode = false;
      addForm.style.display = 'none';
      topReturn.style.display = 'none';
      addModeToggle.style.display = 'inline-block';
      addModeToggle.textContent = '新增';
      removeModeToggle.style.display = 'inline-block';
      clearAddForm();
    }

    confirmAdd.addEventListener('click', ()=>{
      const file = iconFile.files && iconFile.files[0];
      const name = (bookmarkName.value||'').trim();
      const url = (bookmarkURL.value||'').trim();
      if(!file){ alert('必須上傳圖示才能新增書籤'); return; }
      if(!name || !url){ alert('請輸入書籤名與網址'); return; }
      const reader = new FileReader();
      reader.onload = function(evt){
        addBookmark({ name, url, icon: evt.target.result });
        exitAddMode();
        renderBookmarks();
      };
      reader.readAsDataURL(file);
    });
    function clearAddForm(){ iconFile.value=''; bookmarkName.value=''; bookmarkURL.value=''; }

    /* ---------------------------
       Remove mode
       - entering remove mode hides add button
       - remove toggle becomes blue "完成" to exit
       --------------------------- */
    removeModeToggle.addEventListener('click', ()=>{
      if(!removeMode) enterRemoveMode(); else exitRemoveMode();
    });
    function enterRemoveMode(){
      exitAddMode();
      removeMode = true;
      selectedBookmarks.clear();
      removeControls.style.display = 'flex';
      removeModeToggle.classList.remove('btn-red'); removeModeToggle.classList.add('btn-blue'); removeModeToggle.textContent = '完成';
      addModeToggle.style.display = 'none';
      renderBookmarks();
    }
    function exitRemoveMode(){
      removeMode = false;
      selectedBookmarks.clear();
      removeControls.style.display = 'none';
      removeModeToggle.classList.remove('btn-blue'); removeModeToggle.classList.add('btn-red'); removeModeToggle.textContent = '移除';
      addModeToggle.style.display = 'inline-block';
      renderBookmarks();
    }
    removeSelected.addEventListener('click', ()=>{
      if(selectedBookmarks.size === 0){ alert('未選擇任何書籤'); return; }
      let arr = loadBookmarks(); arr = arr.filter(b => !selectedBookmarks.has(b.id)); saveBookmarks(arr); selectedBookmarks.clear(); exitRemoveMode(); renderBookmarks();
    });

    /* ---------------------------
       Main actions: add record + navigation
       --------------------------- */
    function getInputVal(){ return queryInput.value.trim(); }
    function performGo(){ const v = getInputVal(); if(!v){ alert('請輸入有效URL或想查詢的東西'); return; } addRecord(v); if(isLikelyURL(v)){ const dest = v.match(/^https?:\/\//i)? v : ('https://' + v); window.open(dest,'_blank'); } else { const tmpl = engineSelect.value; window.open(tmpl.replace('%s',encodeURIComponent(v)), '_blank'); } }
    function performTranslate(){ const v = getInputVal(); if(!v){ alert('請輸入有效URL或想查詢的東西'); return; } addRecord(v); if(isLikelyURL(v)){ const dest = v.match(/^https?:\/\//i)? v : ('https://' + v); try{ const u=new URL(dest); const host = u.hostname.replace(/\./g,'-') + '.translate.goog'; const final=`https://${host}${u.pathname}?_x_tr_sl=auto&_x_tr_tl=en&_x_tr_hl=en&_x_tr_pto=wapp&_x_tr_hist=true`; window.open(final,'_blank'); }catch(e){ alert('無效的網址格式'); } } else { const tran=`https://translate.google.com/?sl=auto&tl=en&text=${encodeURIComponent(v)}&op=translate`; window.open(tran,'_blank'); } }
    function performArchive(){ const v = getInputVal(); if(!v || !isLikelyURL(v)){ alert('請輸入有效URL'); return; } addRecord(v); const dest = v.match(/^https?:\/\//i)? v : ('https://' + v); const code = new Date().getFullYear() + '0000000000*'; window.open(`https://web.archive.org/web/${code}/${dest}`, '_blank'); }
    goButton.addEventListener('click', performGo);
    translateButton.addEventListener('click', performTranslate);
    archiveButton.addEventListener('click', performArchive);
    document.getElementById('searchForm').addEventListener('submit', (e)=>{ e.preventDefault(); performGo(); });

    /* ---------------------------
       Init / helpers
       --------------------------- */
    function loadBookmarks(){ return loadJSON(STORAGE.BOOKMARKS); }
    function saveBookmarks(arr){ saveJSON(STORAGE.BOOKMARKS, arr); }

    function renderBookmarks(){ // exported earlier but ensure accessible
      const arr = loadBookmarks();
      bookmarkGrid.innerHTML = '';
      if(arr.length === 0){ const el = document.createElement('div'); el.className='muted'; el.textContent=''; bookmarkGrid.appendChild(el); return; }
      arr.forEach(b=>{
        const card = document.createElement('div'); card.className='bookmark-card'; card.dataset.id = b.id;
        const cb = document.createElement('div'); cb.className='select-checkbox'; cb.textContent='✓';
        const img = document.createElement('img'); img.alt = b.name||''; img.src = b.icon || '';
        const name = document.createElement('div'); name.className='bookmark-name'; name.textContent = b.name || '';
        card.appendChild(cb); card.appendChild(img); card.appendChild(name);
        card.addEventListener('click', ()=>{
          if(removeMode){
            if(selectedBookmarks.has(b.id)){ selectedBookmarks.delete(b.id); card.classList.remove('selected'); } else { selectedBookmarks.add(b.id); card.classList.add('selected'); }
            selectedCount.textContent = String(selectedBookmarks.size);
          } else {
            if(b.url && b.url.trim()){ const dest = b.url.match(/^https?:\/\//i)? b.url : ('https://' + b.url); window.open(dest,'_blank'); } else { queryInput.value = b.name||''; overlay.classList.remove('active'); overlay.setAttribute('aria-hidden','true'); }
          }
        });
        if(removeMode) card.classList.add('select-mode'); else card.classList.remove('select-mode');
        if(selectedBookmarks.has(b.id)) card.classList.add('selected'); else card.classList.remove('selected');
        bookmarkGrid.appendChild(card);
      });
      selectedCount.textContent = String(selectedBookmarks.size || 0);
    }

    // initialization
    function init(){
      if(!localStorage.getItem(STORAGE.BOOKMARKS)) saveBookmarks([]);
      if(!localStorage.getItem(STORAGE.RECORDS)) saveRecordsRaw([]);
      // ensure panel title and support link
      document.getElementById('panelTitle').textContent = '書籤';
      document.getElementById('supportLink').setAttribute('href','https://www.youtube.com/@Minecraft_TryingTNH-db5pb');
      document.getElementById('supportLink').textContent = '支持作者';
      // initial rendering
      renderBookmarks();
    }
    init();
  </script>
</body>
</html>
