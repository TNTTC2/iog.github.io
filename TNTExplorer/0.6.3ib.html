<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TNTExplorer 分支 0.6.3(Internal b)</title>
  <style>
    :root{
      --orange:#ED732E; --black:#000; --white:#fff;
      --green:#28a745; --red:#dc3545; --yellow:#ffd400; --gray:#6c757d;
    }
    html,body{height:100%;margin:0;font-family:Arial, sans-serif;background:linear-gradient(to bottom,var(--orange) 0%,var(--orange)20%,#fff 20%,#fff 80%,var(--orange)80%,var(--orange)100%);display:flex;align-items:center;justify-content:center;}
    .search-container{background:var(--black);color:var(--white);width:90%;max-width:400px;padding:20px 24px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.5);position:relative;z-index:1}
    .search-row{display:flex;align-items:center;margin-bottom:10px}
    .search-row input[type="text"]{flex:1;padding:10px;border-radius:8px;border:none;font-size:16px;outline:none}
    #historyButton{width:40px;height:40px;margin-left:8px;background:var(--yellow);border:none;border-radius:6px;cursor:pointer;font-size:18px}
    .button-row{display:flex;justify-content:space-between;margin-bottom:10px}
    .button-row button{width:48%;padding:10px;border-radius:8px;border:none;cursor:pointer;font-size:16px}
    #translateButton{background:var(--green);color:#fff}#goButton{background:#0073e6;color:#fff}
    #archiveButton{width:100%;padding:12px;border-radius:8px;border:none;background:var(--red);color:#fff;cursor:pointer}
    .footer{position:fixed;left:0;right:0;bottom:20px;text-align:center;color:#fff;font-size:14px}
    .footer a{color:#fff;text-decoration:none}
    .version{margin-top:4px;font-size:12px;color:#fff}

    /* overlay panel */
    .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);align-items:center;justify-content:center;z-index:2000}
    .overlay.active{display:flex}
    .panel{background:var(--black);color:var(--white);width:92%;max-width:600px;border-radius:8px;padding:14px;max-height:90%;overflow:auto;position:relative}
    .panel .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .left-controls{display:flex;gap:8px;align-items:center}
    .btn-gray{background:var(--gray);border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer}
    .btn-yellow{background:var(--yellow);border:none;color:#000;padding:6px 10px;border-radius:6px;cursor:pointer}
    .btn-red{background:var(--red);border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer}
    .menu-select{background:transparent;border:1px solid #333;color:#fff;padding:6px;border-radius:6px}
    .panel .title{font-weight:700;font-size:16px}
    .content{display:grid;grid-template-columns:1fr;gap:10px}
    .record-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;background:rgba(255,255,255,0.03);word-break:break-word}
    .record-item .text{flex:1;margin-right:8px;color:#fff}
    .record-item .btn-red{background:var(--red);border:none;color:#fff;padding:6px 8px;border-radius:6px;cursor:pointer}
    .bookmark-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
    .bookmark-card{background:rgba(255,255,255,0.03);padding:10px;border-radius:8px;display:flex;flex-direction:column;align-items:center;gap:8px;position:relative;cursor:pointer}
    .bookmark-card img{width:64px;height:64px;border-radius:8px;object-fit:cover;background:#333}
    .bookmark-name{font-size:14px;color:#fff;word-break:break-word;text-align:center}
    /* remove-mode selection overlay (checkbox top-right) */
    .select-checkbox{position:absolute;top:8px;right:8px;width:18px;height:18px;border-radius:4px;border:2px solid rgba(255,255,255,0.6);background:transparent;display:none;align-items:center;justify-content:center;color:#fff;font-weight:bold}
    .bookmark-card.select-mode .select-checkbox{display:flex}
    .bookmark-card.selected{outline:3px solid var(--red)}
    .bookmark-controls{display:flex;align-items:center;gap:8px;margin-top:8px}
    .count-badge{background:var(--green);padding:6px 10px;border-radius:8px;color:#fff;font-weight:700}
    .remove-btn{background:var(--red);color:#fff;padding:6px 10px;border-radius:8px;border:none;cursor:pointer}

    .add-form{display:flex;flex-direction:column;gap:8px;padding:6px;border-radius:6px;background:rgba(255,255,255,0.02);margin-bottom:8px}
    .add-form input[type="text"]{padding:8px;border-radius:6px;border:none}
    .add-form input[type="file"]{color:#fff}
    .add-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:6px}
    .btn-cancel{background:#888;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;color:#fff}
    .muted{color:#bbb;font-size:13px}
  </style>
</head>
<body>
  <!-- main UI -->
  <div class="search-container" id="mainUI">
    <div class="search-row">
      <input type="text" id="query" placeholder="" autocomplete="off"/>
      <button type="button" id="historyButton" title="Bookmarks / Records">⧆</button>
    </div>
    <div class="button-row">
      <button type="button" id="translateButton" title=""></button>
      <button type="button" id="goButton" title=""></button>
    </div>
    <button id="archiveButton" title=""></button>
  </div>

  <!-- overlay panel -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true">
      <div class="topbar">
        <div class="left-controls">
          <button id="closePanel" class="btn-gray">關閉</button>
          <select id="panelMenu" class="menu-select" aria-label="選單位置">
            <option value="bookmarks">書籤</option>
            <option value="records">探索記錄</option>
          </select>
          <button id="addBookmarkBtn" class="btn-yellow">新增</button>
          <!-- Removing entry: this red button toggles remove-mode -->
          <button id="enterRemoveModeBtn" class="btn-red">移除</button>
        </div>
        <div class="title" id="panelTitle">書籤</div>
      </div>

      <!-- Bookmarks view -->
      <div id="bookmarksView" class="content" style="display:block">
        <div class="muted">新增書籤須上傳圖示，否則無法新增</div>
        <div class="add-form" id="addForm" style="display:none">
          <input type="file" id="iconFile" accept="image/*"/>
          <input type="text" id="bookmarkName" placeholder="輸入書籤名"/>
          <input type="text" id="bookmarkURL" placeholder="輸入書籤網址"/>
          <div class="add-actions">
            <button class="btn-cancel" id="cancelAdd">取消</button>
            <button class="btn-yellow" id="confirmAdd">新增書籤</button>
          </div>
        </div>

        <!-- remove-mode controls (hidden unless in remove-mode) -->
        <div id="removeModeControls" style="display:none;align-items:center;gap:10px;margin:8px 0">
          <div class="count-badge" id="selectedCount">0</div>
          <button class="remove-btn" id="removeSelected">移除所選</button>
        </div>

        <div id="bookmarkGrid" class="bookmark-grid" aria-live="polite"></div>
      </div>

      <!-- Records view -->
      <div id="recordsView" class="content" style="display:none">
        <ul id="recordsList" style="list-style:none;padding:0;margin:0"></ul>
      </div>

    </div>
  </div>

  <div class="footer">
    <a href="#" id="supportLink">支持作者</a>
    <div class="version">版本號: 0.6.3(Internal "b")</div>
  </div>

  <script>
    /* Branch note: branch-only changes. Do not use as main template. */

    const STORAGE = {
      RECORDS: 'tnt_explore_records_branch',
      BOOKMARKS: 'tnt_explore_bookmarks_branch'
    };

    function loadJSON(key){ try{ return JSON.parse(localStorage.getItem(key)||'[]') }catch{ return [] } }
    function saveJSON(key,val){ localStorage.setItem(key, JSON.stringify(val)) }
    function uid(){ return 'id_' + Date.now().toString(36) + Math.random().toString(36).slice(2,8) }

    // elements
    const overlay = document.getElementById('overlay');
    const historyButton = document.getElementById('historyButton');
    const panelMenu = document.getElementById('panelMenu');
    const panelTitle = document.getElementById('panelTitle');
    const bookmarksView = document.getElementById('bookmarksView');
    const recordsView = document.getElementById('recordsView');
    const addBookmarkBtn = document.getElementById('addBookmarkBtn');
    const addForm = document.getElementById('addForm');
    const iconFile = document.getElementById('iconFile');
    const bookmarkName = document.getElementById('bookmarkName');
    const bookmarkURL = document.getElementById('bookmarkURL');
    const cancelAdd = document.getElementById('cancelAdd');
    const confirmAdd = document.getElementById('confirmAdd');
    const bookmarkGrid = document.getElementById('bookmarkGrid');
    const selectedCount = document.getElementById('selectedCount');
    const removeSelected = document.getElementById('removeSelected');
    const recordsList = document.getElementById('recordsList');
    const closePanel = document.getElementById('closePanel');
    const enterRemoveModeBtn = document.getElementById('enterRemoveModeBtn');
    const removeModeControls = document.getElementById('removeModeControls');

    let removeMode = false;               // when true, showing selection UI
    let selectedBookmarks = new Set();

    // open panel (default to bookmarks)
    historyButton.addEventListener('click', ()=>{
      panelMenu.value = 'bookmarks';
      switchPanelView('bookmarks');
      overlay.classList.add('active'); overlay.setAttribute('aria-hidden','false');
    });

    panelMenu.addEventListener('change', e => switchPanelView(e.target.value));

    function switchPanelView(mode){
      removeMode = false; selectedBookmarks.clear(); updateRemoveModeUI();
      if(mode === 'bookmarks'){
        bookmarksView.style.display = 'block';
        recordsView.style.display = 'none';
        panelTitle.textContent = '書籤';
        renderBookmarks();
      } else {
        bookmarksView.style.display = 'none';
        recordsView.style.display = 'block';
        panelTitle.textContent = '探索記錄';
        renderRecords();
      }
      addForm.style.display = 'none';
    }

    closePanel.addEventListener('click', ()=>{ overlay.classList.remove('active'); overlay.setAttribute('aria-hidden','true'); });
    overlay.addEventListener('click', e => { if(e.target === overlay){ overlay.classList.remove('active'); overlay.setAttribute('aria-hidden','true'); } });

    /* Records */
    function loadRecords(){ return loadJSON(STORAGE.RECORDS) }
    function saveRecords(arr){ saveJSON(STORAGE.RECORDS, arr) }
    function addRecord(text){ if(!text||!text.trim()) return; const arr = loadRecords(); arr.push({id:uid(), text}); saveRecords(arr); }
    function renderRecords(){
      const arr = loadRecords().slice().reverse();
      recordsList.innerHTML = '';
      if(arr.length === 0){ const li = document.createElement('li'); li.className='record-item muted'; li.textContent=''; recordsList.appendChild(li); return; }
      arr.forEach(item=>{
        const li = document.createElement('li'); li.className='record-item';
        const txt = document.createElement('div'); txt.className='text'; txt.textContent = item.text;
        const btn = document.createElement('button'); btn.className='btn-red'; btn.textContent='清除';
        btn.addEventListener('click', ()=> { const current = loadRecords().filter(r=>r.id!==item.id); saveRecords(current); renderRecords(); });
        li.appendChild(txt); li.appendChild(btn); recordsList.appendChild(li);
      });
    }

    /* Bookmarks */
    function loadBookmarks(){ return loadJSON(STORAGE.BOOKMARKS) }
    function saveBookmarks(arr){ saveJSON(STORAGE.BOOKMARKS, arr) }

    function renderBookmarks(){
      const arr = loadBookmarks();
      bookmarkGrid.innerHTML = '';
      if(arr.length === 0){ const el = document.createElement('div'); el.className='muted'; el.textContent=''; bookmarkGrid.appendChild(el); return; }
      arr.forEach(b=>{
        const card = document.createElement('div'); card.className='bookmark-card'; card.dataset.id=b.id;
        const img = document.createElement('img'); img.alt = b.name||''; img.src = b.icon||'';
        const name = document.createElement('div'); name.className='bookmark-name'; name.textContent=b.name||'';
        // select checkbox visible only in remove-mode
        const cb = document.createElement('div'); cb.className='select-checkbox'; cb.textContent='✓';
        card.appendChild(cb);
        // clicking card behavior:
        card.addEventListener('click', (e)=>{
          if(removeMode){
            // toggle selection
            if(selectedBookmarks.has(b.id)) selectedBookmarks.delete(b.id);
            else selectedBookmarks.add(b.id);
            if(selectedBookmarks.has(b.id)) card.classList.add('selected'); else card.classList.remove('selected');
            updateSelectedCount();
          } else {
            // navigate to bookmark.url (open in new tab) OR if url empty, put text to query
            if(b.url && b.url.trim()){
              const dest = b.url.match(/^https?:\/\//i) ? b.url : ('https://' + b.url);
              window.open(dest,'_blank');
            } else if(b.name){
              document.getElementById('query').value = b.name;
              overlay.classList.remove('active'); overlay.setAttribute('aria-hidden','true');
            }
          }
        });
        // name click navigates same as clicking whole card but stop propagation to avoid double handling
        name.addEventListener('click', (ev)=>{ ev.stopPropagation(); card.click(); });
        card.appendChild(img); card.appendChild(name);
        // visually indicate select-mode
        if(removeMode) card.classList.add('select-mode'); else card.classList.remove('select-mode');
        if(selectedBookmarks.has(b.id)) card.classList.add('selected'); else card.classList.remove('selected');
        bookmarkGrid.appendChild(card);
      });
      updateSelectedCount();
    }

    function updateSelectedCount(){ selectedCount.textContent = String(selectedBookmarks.size || 0); }

    // add bookmark UI
    addBookmarkBtn.addEventListener('click', ()=>{ addForm.style.display = addForm.style.display==='none' ? 'flex' : 'none'; });
    cancelAdd.addEventListener('click', ()=>{ addForm.style.display='none'; clearAddForm(); });
    confirmAdd.addEventListener('click', ()=>{
      const file = iconFile.files && iconFile.files[0];
      const name = (bookmarkName.value||'').trim();
      const url = (bookmarkURL.value||'').trim();
      if(!file){ alert('必須上傳圖示才能新增書籤'); return; }
      if(!name || !url){ alert('請輸入書籤名與網址'); return; }
      const reader = new FileReader();
      reader.onload = function(evt){
        const arr = loadBookmarks(); arr.push({id:uid(), name, url, icon: evt.target.result}); saveBookmarks(arr); clearAddForm(); addForm.style.display='none'; renderBookmarks();
      };
      reader.readAsDataURL(file);
    });
    function clearAddForm(){ iconFile.value=''; bookmarkName.value=''; bookmarkURL.value=''; }

    // remove-mode entry toggles selection UI
    enterRemoveModeBtn.addEventListener('click', ()=>{
      removeMode = !removeMode;
      selectedBookmarks.clear();
      // show remove-mode controls only when removeMode true
      removeModeControls.style.display = removeMode ? 'flex' : 'none';
      renderBookmarks();
    });

    // remove selected bookmarks action
    removeSelected.addEventListener('click', ()=>{
      if(selectedBookmarks.size === 0){ alert('未選擇任何書籤'); return; }
      let arr = loadBookmarks();
      arr = arr.filter(b => !selectedBookmarks.has(b.id));
      saveBookmarks(arr);
      selectedBookmarks.clear();
      removeMode = false;
      removeModeControls.style.display = 'none';
      renderBookmarks();
    });

    // integrate with main actions: save records only (branch: no navigation)
    const goButton = document.getElementById('goButton');
    const translateButton = document.getElementById('translateButton');
    const archiveButton = document.getElementById('archiveButton');
    function getInputVal(){ return document.getElementById('query').value.trim(); }
    goButton.addEventListener('click', ()=>{ const v = getInputVal(); if(!v) return; addRecordBranch(v); });
    translateButton.addEventListener('click', ()=>{ const v = getInputVal(); if(!v) return; addRecordBranch(v); });
    archiveButton.addEventListener('click', ()=>{ const v = getInputVal(); if(!v) return; addRecordBranch(v); });

    function addRecordBranch(text){ if(!text||!text.trim()) return; const arr = loadRecords(); arr.push({id:uid(), text}); saveRecords(arr); }

    function init(){
      if(!localStorage.getItem(STORAGE.BOOKMARKS)) saveBookmarks([]);
      if(!localStorage.getItem(STORAGE.RECORDS)) saveRecords([]);
      selectedBookmarks.clear();
      removeMode = false; removeModeControls.style.display='none';
    }
    init();

    // open panel helper
    historyButton.addEventListener('click', ()=>{ panelMenu.value='bookmarks'; switchPanelView('bookmarks'); overlay.classList.add('active'); overlay.setAttribute('aria-hidden','false'); });
    panelMenu.addEventListener('change',(e)=>switchPanelView(e.target.value));
    function switchPanelView(mode){
      removeMode = false; selectedBookmarks.clear(); removeModeControls.style.display='none';
      if(mode==='bookmarks'){ bookmarksView.style.display='block'; recordsView.style.display='none'; panelTitle.textContent='書籤'; renderBookmarks(); }
      else { bookmarksView.style.display='none'; recordsView.style.display='block'; panelTitle.textContent='探索記錄'; renderRecords(); }
      addForm.style.display='none';
    }
    closePanel.addEventListener('click', ()=>{ overlay.classList.remove('active'); overlay.setAttribute('aria-hidden','true'); });
    overlay.addEventListener('click', e=>{ if(e.target===overlay){ overlay.classList.remove('active'); overlay.setAttribute('aria-hidden','true'); } });

    // renderRecords uses functions above
  </script>
</body>
</html>
