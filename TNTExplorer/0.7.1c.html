<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TNTExplorer 探索器</title>

  <link rel="icon" href="https://tnttc2.github.io/iog.github.io/TNTExplorer/icon.jpeg" type="image/jpeg"/>
  <link rel="apple-touch-icon" href="https://tnttc2.github.io/iog.github.io/TNTExplorer/icon.jpeg"/>

  <style>
    /* 使用 0.6.3 主介面尺寸/排版為基準，並保留 0.7.x 面板樣式 */
    :root{
      --orange:#ED732E; --black:#000; --white:#ffffff; --muted:#bbb;
      --green:#28a745; --red:#dc3545; --blue:#007bff; --yellow:#ffd400;
      --panel-bg: rgba(0,0,0,0.92); --overlay-bg: rgba(0,0,0,0.75);
    }

    @media (prefers-color-scheme: dark) {
      :root{ --white:#e6e6e6; --muted:#c2c2c2; --panel-bg: rgba(18,18,18,0.98); --overlay-bg: rgba(0,0,0,0.85); }
      body { background: linear-gradient(to bottom, #b95a20 0%, #b95a20 20%, #2f2f2f 20%, #2f2f2f 80%, #b95a20 80%, #b95a20 100%); }
    }

    html,body { margin:0; padding:0; height:100vh; font-family:Arial, sans-serif;
      background: linear-gradient(to bottom,
        var(--orange) 0%, var(--orange) 20%,
        var(--white) 20%, var(--white) 80%,
        var(--orange) 80%, var(--orange) 100%);
      display:flex; align-items:center; justify-content:center; position:relative;
    }

    /* --- 主搜尋區 (恢復 0.6.3 樣式) --- */
    .search-container { background:#000; color:#fff; width:90%; max-width:400px;
      padding:20px 30px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.5);
      text-align:center; z-index:1;
    }
    .search-container h1 { font-size:28px; margin:0 0 5px; }
    .subtitle { font-size:16px; margin:0 0 20px; opacity:0.8; font-style:italic; }

    .engine-select { text-align:left; margin-bottom:12px; }
    .engine-select select { width:100%; padding:8px; font-size:16px; border:none; border-radius:6px; outline:none; }

    .search-row { display:flex; align-items:center; margin-bottom:10px; }
    .search-row input[type="text"] { flex:1; padding:10px; font-size:16px; border:none; border-radius:8px; outline:none; background:#111; color:var(--white); }
    #historyButton { width:40px; height:40px; margin-left:5px; background:var(--yellow); border:none; border-radius:5px; cursor:pointer; font-size:18px; line-height:1; }

    .button-row { display:flex; justify-content:space-between; margin-bottom:10px; }
    .button-row button { width:48%; padding:10px; font-size:16px; border:none; border-radius:8px; cursor:pointer; }
    #translateButton { background:var(--green); color:#fff; } #translateButton:hover { background:#218838; }
    #goButton { background:#0073e6; color:#fff; } #goButton:hover { background:#005bb5; }

    #archiveButton { width:100%; padding:12px; font-size:16px; border:none; border-radius:8px; background:var(--red); color:#fff; cursor:pointer; }
    #archiveButton:hover { background:#c82333; }

    /* --- 覆蓋層 (探索 / 書籤 面板) --- */
    .overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:var(--overlay-bg); align-items:center; justify-content:center; z-index:1000; }
    .overlay.active { display:flex; }
    .panel { background:var(--panel-bg); color:var(--white); padding:20px; border-radius:8px; width:90%; max-width:500px; max-height:90%; overflow:auto; position:relative; } /* max-width 500px 為 0.6.3 panel 大小 */

    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; gap:8px; }
    .left-controls { display:flex; gap:8px; align-items:center; }
    .btn-gray { background:#6c757d; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    .btn-yellow { background:var(--yellow); color:#000; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    .btn-red { background:var(--red); color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    .btn-blue { background:var(--blue); color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }

    .menu-select { background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--white); padding:6px 8px; border-radius:6px; }
    .panel .title { font-size:18px; font-weight:700; }

    .description { color:var(--muted); font-size:14px; margin-bottom:10px; }

    /* Records list */
    #recordsView .record-item { display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:8px; background: rgba(255,255,255,0.03); margin-bottom:8px; word-break:break-word; }
    #recordsView .record-item .text { color:var(--white); flex:1; margin-right:10px; text-align:left; cursor:pointer; }

    /* Bookmarks: 4 per row grid (restored) */
    .bookmark-grid { display:grid; grid-template-columns: repeat(4,1fr); gap:10px; }
    .bookmark-card { background: rgba(255,255,255,0.03); padding:10px; border-radius:8px; display:flex; flex-direction:column; align-items:center; gap:8px; cursor:pointer; position:relative; min-height:110px; }
    .bookmark-card img { width:64px; height:64px; border-radius:8px; object-fit:cover; background:#333; }
    .bookmark-name { font-size:13px; color:var(--white); text-align:center; word-break:break-word; }
    .bookmark-card .select-checkbox { position:absolute; top:8px; right:8px; width:18px; height:18px; border-radius:4px; border:2px solid rgba(255,255,255,0.6); display:none; align-items:center; justify-content:center; color:#fff; font-weight:bold; }
    .bookmark-card.select-mode .select-checkbox { display:flex; }
    .bookmark-card.selected { outline:3px solid var(--red); }

    .remove-controls { display:flex; align-items:center; gap:10px; margin:10px 0; }
    .count-badge { background:var(--green); color:#fff; padding:6px 10px; border-radius:8px; font-weight:700; }

    .add-form { display:flex; flex-direction:column; gap:8px; padding:6px; border-radius:6px; background: rgba(255,255,255,0.02); margin-bottom:8px; }
    .add-form input[type="text"], .add-form input[type="file"] { padding:8px; border-radius:6px; border:none; color:var(--white); background:rgba(255,255,255,0.03); }
    .add-actions { display:flex; justify-content:flex-end; gap:8px; }

    @media (max-width:800px){ .bookmark-grid { grid-template-columns: repeat(3,1fr); } }
    @media (max-width:520px){ .bookmark-grid { grid-template-columns: repeat(2,1fr); } .search-container { max-width:360px; } }

    /* Footer */
    .footer { position:absolute; bottom:20px; width:100%; text-align:center; font-size:16px; color:#fff; z-index:1; }
    .footer a { color:#fff; text-decoration:none; }
    .version { margin-top:5px; font-size:14px; }
  </style>
</head>
<body>
  <!-- 主介面 (已恢復 0.6.3 樣式，標題與 subtitle 顯示) -->
  <div class="search-container">
    <h1>TNTExplorer 探索器</h1>
    <div class="subtitle">由TNH Minecraft負責監督，Copilot負責實行</div>

    <div class="engine-select">
      <label for="engine" style="display:none;"></label>
      <select id="engine">
        <option value="https://www.google.com/search?num=70&udm=14&q=%s" selected>Google</option>
        <option value="https://www.bing.com/search?q=%s">Bing</option>
        <option value="https://www.youtube.com/results?search_query=%s">YouTube</option>
        <option value="https://www.reddit.com/search/?q=%s">Reddit</option>
      </select>
    </div>

    <form id="searchForm">
      <div class="search-row">
        <input type="text" id="query" placeholder="請輸入查詢或網址…" autocomplete="off" />
        <button type="button" id="historyButton">⧆</button>
      </div>

      <div class="button-row">
        <button type="button" id="translateButton">翻譯</button>
        <button type="button" id="goButton">前往</button>
      </div>
    </form>

    <button id="archiveButton">查看舊版網頁</button>
  </div>

  <!-- 覆蓋式面板（探索記錄 / 書籤），寬度與 0.6.3 相同 -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="panelTitle">
      <div class="topbar">
        <div class="left-controls">
          <button id="closePanel" class="btn-gray">關閉</button>
          <select id="panelMenu" class="menu-select" aria-label="選單位置">
            <option value="bookmarks">書籤</option>
            <option value="records">探索記錄</option>
          </select>

          <button id="addBookmarkBtn" class="btn-yellow">新增</button>
          <button id="toggleRemoveModeBtn" class="btn-red">移除</button>
        </div>
        <div class="title" id="panelTitle">書籤</div>
      </div>

      <!-- 描述（修正為只有一行） -->
      <div id="panelDescription">
        <p id="exploreDesc" class="description" style="display:none">查看你的搜尋、翻譯、前往網站等紀錄</p>
      </div>

      <!-- 書籤視圖 -->
      <div id="bookmarksView" class="content" style="display:block">
        <div class="muted" style="margin-bottom:6px">新增書籤須上傳圖示，否則無法新增</div>

        <div id="addForm" class="add-form" style="display:none">
          <input type="file" id="iconFile" accept="image/*"/>
          <input type="text" id="bookmarkName" placeholder="輸入書籤名"/>
          <input type="text" id="bookmarkURL" placeholder="輸入書籤網址"/>
          <div class="add-actions">
            <button class="btn-gray" id="cancelAdd">取消</button>
            <button class="btn-yellow" id="confirmAdd">完成</button>
          </div>
        </div>

        <div id="removeControls" style="display:none" class="remove-controls">
          <div class="count-badge" id="selectedCount">0</div>
          <button id="removeSelected" class="btn-red">移除所選</button>
        </div>

        <div id="bookmarkGrid" class="bookmark-grid" aria-live="polite"></div>
      </div>

      <!-- 探索記錄視圖 -->
      <div id="recordsView" class="content" style="display:none">
        <div id="recordsList"></div>
      </div>
    </div>
  </div>

  <div class="footer">
    <a href="https://www.youtube.com/@Minecraft_TryingTNH-db5pb" id="supportLink" target="_blank">支持作者</a>
    <div class="version">版本號: 0.7.1c</div>
  </div>

  <script>
    // RECORDS key 回復為 0.6.3 使用的 key，避免因 key 改變導致舊紀錄看不到
    const STORAGE = { RECORDS: 'tntExplorerHistory', BOOKMARKS: 'tnt_explore_bookmarks' };

    function loadJSON(key){ try{ return JSON.parse(localStorage.getItem(key) || '[]'); } catch(e){ return []; } }
    function saveJSON(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
    function uid(){ return 'id_' + Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
    function normalizeKey(s){ return (s||'').trim().toLowerCase(); }
    function isLikelyURL(str){ return /(:\/\/)|(^(?!\.)\S+\.[^\s]+$)/i.test(str); }

    // UI refs
    const overlay = document.getElementById('overlay');
    const historyButton = document.getElementById('historyButton');
    const panelMenu = document.getElementById('panelMenu');
    const panelTitle = document.getElementById('panelTitle');
    const bookmarksView = document.getElementById('bookmarksView');
    const recordsView = document.getElementById('recordsView');
    const addBookmarkBtn = document.getElementById('addBookmarkBtn');
    const addForm = document.getElementById('addForm');
    const iconFile = document.getElementById('iconFile');
    const bookmarkName = document.getElementById('bookmarkName');
    const bookmarkURL = document.getElementById('bookmarkURL');
    const cancelAdd = document.getElementById('cancelAdd');
    const confirmAdd = document.getElementById('confirmAdd');
    const bookmarkGrid = document.getElementById('bookmarkGrid');
    const removeControls = document.getElementById('removeControls');
    const selectedCount = document.getElementById('selectedCount');
    const removeSelected = document.getElementById('removeSelected');
    const recordsList = document.getElementById('recordsList');
    const closePanel = document.getElementById('closePanel');
    const toggleRemoveModeBtn = document.getElementById('toggleRemoveModeBtn');
    const exploreDesc = document.getElementById('exploreDesc');
    const engineSelect = document.getElementById('engine');
    const queryInput = document.getElementById('query');
    const goButton = document.getElementById('goButton');
    const translateButton = document.getElementById('translateButton');
    const archiveButton = document.getElementById('archiveButton');

    let removeMode = false;
    let selectedBookmarks = new Set();

    /* -------------------------
       Records: 兼容舊格式 (array of strings or array of objects)
       - renderRecords 會正確顯示舊紀錄文字並可點擊
       ------------------------- */
    function loadRecordsRaw(){ return loadJSON(STORAGE.RECORDS); }

    function addRecord(text){
      if(!text || !text.trim()) return;
      const raw = loadRecordsRaw();
      // if raw is empty or first item is string, keep string-array format
      const usesString = raw.length === 0 || typeof raw[0] === 'string';
      if(usesString){
        raw.push(text);
        saveJSON(STORAGE.RECORDS, raw);
      } else {
        raw.push({ id: uid(), text });
        saveJSON(STORAGE.RECORDS, raw);
      }
    }

    function renderRecords(){
      const raw = loadRecordsRaw();
      // normalize to display entries as {id,text}
      const items = raw.map(it => {
        if(typeof it === 'string') return { id: uid(), text: it };
        if(it && typeof it === 'object') return { id: it.id || uid(), text: it.text || (Object.values(it).find(v => typeof v==='string') || '') };
        return { id: uid(), text: '' };
      }).reverse();

      recordsList.innerHTML = '';
      if(items.length === 0){
        const p = document.createElement('div'); p.className='muted'; p.textContent = ''; recordsList.appendChild(p); return;
      }

      items.forEach(item => {
        const row = document.createElement('div'); row.className = 'record-item';
        const t = document.createElement('div'); t.className = 'text'; t.textContent = item.text || '';
        t.addEventListener('click', () => {
          if(!item.text) return;
          if(isLikelyURL(item.text)){
            const dest = item.text.match(/^https?:\/\//i) ? item.text : ('https://' + item.text);
            window.open(dest, '_blank');
          } else {
            queryInput.value = item.text;
            overlay.classList.remove('active'); overlay.setAttribute('aria-hidden','true');
          }
        });

        const b = document.createElement('button'); b.className = 'btn-red'; b.textContent = '清除';
        b.addEventListener('click', () => {
          const rawBefore = loadRecordsRaw();
          const idx = rawBefore.findIndex(r => (typeof r==='string' && r === item.text) || (r && r.text === item.text));
          if(idx !== -1){ rawBefore.splice(idx,1); saveJSON(STORAGE.RECORDS, rawBefore); renderRecords(); }
        });

        row.appendChild(t); row.appendChild(b);
        recordsList.appendChild(row);
      });
    }

    /* -------------------------
       Bookmarks (same behavior)
       ------------------------- */
    function loadBookmarks(){ return loadJSON(STORAGE.BOOKMARKS); }
    function saveBookmarks(arr){ saveJSON(STORAGE.BOOKMARKS, arr); }
    function addBookmark({name, url, icon}){
      if(!icon) return;
      const arr = loadBookmarks();
      const key = normalizeKey(name + '|' + (url||''));
      const filtered = arr.filter(b => normalizeKey(b.name + '|' + (b.url||'')) !== key);
      filtered.push({ id: uid(), name, url, icon });
      saveBookmarks(filtered);
    }

    function renderBookmarks(){
      const arr = loadBookmarks();
      bookmarkGrid.innerHTML = '';
      if(arr.length === 0){ const el = document.createElement('div'); el.className='muted'; el.textContent=''; bookmarkGrid.appendChild(el); return; }
      arr.forEach(b=>{
        const card = document.createElement('div'); card.className = 'bookmark-card'; card.dataset.id = b.id;
        const checkbox = document.createElement('div'); checkbox.className = 'select-checkbox'; checkbox.textContent = '✓';
        const img = document.createElement('img'); img.alt = b.name||''; img.src = b.icon || '';
        const name = document.createElement('div'); name.className = 'bookmark-name'; name.textContent = b.name || '';
        card.appendChild(checkbox); card.appendChild(img); card.appendChild(name);

        card.addEventListener('click', (e) => {
          if(removeMode){
            if(selectedBookmarks.has(b.id)){ selectedBookmarks.delete(b.id); card.classList.remove('selected'); } else { selectedBookmarks.add(b.id); card.classList.add('selected'); }
            selectedCount.textContent = String(selectedBookmarks.size);
          } else {
            if(b.url && b.url.trim()){
              const dest = b.url.match(/^https?:\/\//i) ? b.url : ('https://' + b.url);
              window.open(dest, '_blank');
            } else {
              queryInput.value = b.name || '';
              overlay.classList.remove('active'); overlay.setAttribute('aria-hidden','true');
            }
          }
        });

        if(removeMode) card.classList.add('select-mode'); else card.classList.remove('select-mode');
        if(selectedBookmarks.has(b.id)) card.classList.add('selected'); else card.classList.remove('selected');
        bookmarkGrid.appendChild(card);
      });
      selectedCount.textContent = String(selectedBookmarks.size || 0);
    }

    /* -------------------------
       Panel open/close / view switching
       - ensure add/remove hidden in records view
       - description appears once
       ------------------------- */
    function openPanel(defaultView='bookmarks'){ panelMenu.value = defaultView; switchView(defaultView); overlay.classList.add('active'); overlay.setAttribute('aria-hidden','false'); }
    function closePanelFunc(){ overlay.classList.remove('active'); overlay.setAttribute('aria-hidden','true'); exitRemoveMode(); }
    historyButton.addEventListener('click', ()=> openPanel('bookmarks'));
    closePanel.addEventListener('click', closePanelFunc);
    overlay.addEventListener('click', e => { if(e.target === overlay) closePanelFunc(); });

    panelMenu.addEventListener('change', e => switchView(e.target.value));
    function switchView(view){
      exitRemoveMode();
      if(view === 'bookmarks'){
        bookmarksView.style.display = 'block';
        recordsView.style.display = 'none';
        panelTitle.textContent = '書籤';
        exploreDesc.style.display = 'none';
        addBookmarkBtn.style.display = 'inline-block';
        toggleRemoveModeBtn.style.display = 'inline-block';
        renderBookmarks();
      } else {
        bookmarksView.style.display = 'none';
        recordsView.style.display = 'block';
        panelTitle.textContent = '探索記錄';
        exploreDesc.style.display = 'block';
        addBookmarkBtn.style.display = 'none';
        toggleRemoveModeBtn.style.display = 'none';
        renderRecords();
      }
    }

    // add bookmark UI
    addBookmarkBtn.addEventListener('click', ()=>{
      if(addForm.style.display === 'flex'){
        addForm.style.display = 'none';
        addBookmarkBtn.textContent = '新增';
      } else {
        addForm.style.display = 'flex';
        addBookmarkBtn.textContent = '完成';
        exitRemoveMode();
      }
    });
    cancelAdd.addEventListener('click', ()=>{ addForm.style.display = 'none'; addBookmarkBtn.textContent = '新增'; clearAddForm(); });

    confirmAdd.addEventListener('click', ()=>{
      const file = iconFile.files && iconFile.files[0];
      const name = (bookmarkName.value || '').trim();
      const url = (bookmarkURL.value || '').trim();
      if(!file){ alert('必須上傳圖示才能新增書籤'); return; }
      if(!name || !url){ alert('請輸入書籤名與網址'); return; }
      const reader = new FileReader();
      reader.onload = function(evt){
        addBookmark({ name, url, icon: evt.target.result });
        addForm.style.display = 'none';
        addBookmarkBtn.textContent = '新增';
        clearAddForm();
        renderBookmarks();
      };
      reader.readAsDataURL(file);
    });
    function clearAddForm(){ iconFile.value=''; bookmarkName.value=''; bookmarkURL.value=''; }

    // remove-mode toggle
    toggleRemoveModeBtn.addEventListener('click', ()=> { if(!removeMode) enterRemoveMode(); else exitRemoveMode(); });
    function enterRemoveMode(){
      removeMode = true; selectedBookmarks.clear(); renderBookmarks();
      removeControls.style.display = 'flex';
      toggleRemoveModeBtn.classList.remove('btn-red'); toggleRemoveModeBtn.classList.add('btn-blue'); toggleRemoveModeBtn.textContent = '完成';
    }
    function exitRemoveMode(){
      removeMode = false; selectedBookmarks.clear(); renderBookmarks();
      removeControls.style.display = 'none';
      toggleRemoveModeBtn.classList.remove('btn-blue'); toggleRemoveModeBtn.classList.add('btn-red'); toggleRemoveModeBtn.textContent = '移除';
    }
    removeSelected.addEventListener('click', ()=>{
      if(selectedBookmarks.size === 0){ alert('未選擇任何書籤'); return; }
      let arr = loadBookmarks(); arr = arr.filter(b => !selectedBookmarks.has(b.id)); saveBookmarks(arr); selectedBookmarks.clear(); exitRemoveMode(); renderBookmarks();
    });

    // main actions: go/translate/archive (save record and navigate)
    function getInputVal(){ return queryInput.value.trim(); }

    function performGo(){
      const v = getInputVal(); if(!v){ alert('請輸入有效URL或想查詢的東西'); return; }
      addRecord(v);
      if(isLikelyURL(v)){ const dest = v.match(/^https?:\/\//i) ? v : ('https://' + v); window.open(dest, '_blank'); }
      else { const tmpl = engineSelect.value; window.open(tmpl.replace('%s', encodeURIComponent(v)), '_blank'); }
    }
    function performTranslate(){
      const v = getInputVal(); if(!v){ alert('請輸入有效URL或想查詢的東西'); return; }
      addRecord(v);
      if(isLikelyURL(v)){ const dest = v.match(/^https?:\/\//i) ? v : ('https://' + v); try{ const u = new URL(dest); const host = u.hostname.replace(/\./g,'-') + '.translate.goog'; const final = `https://${host}${u.pathname}?_x_tr_sl=auto&_x_tr_tl=en&_x_tr_hl=en&_x_tr_pto=wapp&_x_tr_hist=true`; window.open(final,'_blank'); }catch(e){ alert('無效的網址格式'); } }
      else { const tran = `https://translate.google.com/?sl=auto&tl=en&text=${encodeURIComponent(v)}&op=translate`; window.open(tran,'_blank'); }
    }
    function performArchive(){ const v = getInputVal(); if(!v || !isLikelyURL(v)){ alert('請輸入有效URL'); return; } addRecord(v); const dest = v.match(/^https?:\/\//i) ? v : ('https://' + v); const code = new Date().getFullYear() + '0000000000*'; window.open(`https://web.archive.org/web/${code}/${dest}`, '_blank'); }

    goButton.addEventListener('click', performGo);
    translateButton.addEventListener('click', performTranslate);
    archiveButton.addEventListener('click', performArchive);
    document.getElementById('searchForm').addEventListener('submit', (e)=>{ e.preventDefault(); performGo(); });

    // support initialization
    function init(){
      if(!localStorage.getItem(STORAGE.BOOKMARKS)) saveBookmarks([]);
      if(!localStorage.getItem(STORAGE.RECORDS)) saveJSON(STORAGE.RECORDS, []); // ensure key exists (preserve old)
      panelTitle.textContent = '書籤';
      document.getElementById('supportLink').setAttribute('href','https://www.youtube.com/@Minecraft_TryingTNH-db5pb');
      document.getElementById('supportLink').textContent = '支持作者';
      exitRemoveMode();
    }

    // helper functions used above (re-declared to ensure availability)
    function loadJSON(key){ try{ return JSON.parse(localStorage.getItem(key) || '[]'); } catch(e){ return []; } }
    function saveJSON(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
    function loadBookmarks(){ return loadJSON(STORAGE.BOOKMARKS); }

    init();
  </script>
</body>
</html>
